# =================================================================
# Dockerfile de DESENVOLVIMENTO para o GenieACS (Node.js)
# =================================================================

# Usar a mesma imagem base do Node para consistência
FROM node:20-alpine

# Definir o diretório de trabalho
WORKDIR /opt/genieacs

# Otimização de cache: Instalar dependências apenas se o package.json mudar
COPY ./genieacs-v1.2.13/package*.json ./
RUN npm install

# Copiar o código-fonte do GenieACS
COPY ./genieacs-v1.2.13 .

# Instalar as ferramentas globais necessárias para o nosso fluxo de desenvolvimento
# - ts-node: Para executar TypeScript diretamente
# - nodemon: Para reiniciar os processos em caso de alterações
# - concurrently: Para rodar múltiplos comandos/processos em paralelo
RUN npm install -g ts-node nodemon concurrently

# Expor as portas do GenieACS
EXPOSE 7547 7557 7567 3000

# Comando para iniciar todos os serviços em modo de desenvolvimento
# - "concurrently" roda todos os comandos seguintes em paralelo.
# - Cada serviço é iniciado com "nodemon", que usa "ts-node" para executar.
# - Se você alterar um arquivo relacionado ao 'cwmp', apenas esse serviço reiniciará.
CMD [   "concurrently",   "--names", "CWMP,NBI,FS,UI,EXT",   "-c", "auto",   "nodemon --exec ts-node bin/genieacs-cwmp.ts",   "nodemon --exec ts-node bin/genieacs-nbi.ts",   "nodemon --exec ts-node bin/genieacs-fs.ts",   "nodemon --exec ts-node bin/genieacs-ui.ts",   "nodemon --exec ts-node bin/genieacs-ext.ts" ]
